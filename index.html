<!DOCTYPE html>
<html>
<head>

<title>KAALI AI</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" href="kaali.png">

<style>

html,body{
margin:0;
padding:0;
background:black;
color:white;
font-family:Arial;
height:100%;
overflow:hidden;
display:flex;
justify-content:center;
}

.container{
width:100%;
max-width:420px;
height:100%;
display:flex;
flex-direction:column;
}

.header{
text-align:center;
padding:10px;
border-bottom:1px solid #222;
}

.logo{
width:70px;
animation:glow 3s infinite;
}

.title{
color:gold;
font-size:22px;
}

#messages{
flex:1;
overflow:auto;
padding:10px;
}

.user{
background:#222;
padding:10px;
border-radius:12px;
margin:6px;
}

.kaali{
background:black;
border-left:4px solid gold;
padding:10px;
border-radius:12px;
margin:6px;
}

.gotoBtn{
display:inline-block;
margin-top:10px;
padding:8px 14px;
background:gold;
color:black;
border-radius:8px;
font-weight:bold;
cursor:pointer;
}

.inputArea{
display:flex;
padding:10px;
border-top:1px solid #222;
align-items:center;
}

input{
flex:1;
padding:12px;
border-radius:10px;
border:none;
font-size:15px;
}

button{
background:gold;
border:none;
padding:10px 15px;
border-radius:10px;
margin-left:5px;
cursor:pointer;
font-weight:bold;
}

.recording{
color:red;
margin-left:8px;
animation:pulse 1s infinite;
}

@keyframes glow{
0%{filter:drop-shadow(0 0 2px gold);}
50%{filter:drop-shadow(0 0 12px gold);}
100%{filter:drop-shadow(0 0 2px gold);}
}

@keyframes pulse{
0%{opacity:.3}
50%{opacity:1}
100%{opacity:.3}
}

</style>

</head>

<body>

<div class="container">

<div class="header">
<img src="kaali.png" class="logo">
<div class="title">KAALI AI</div>
</div>

<div id="messages"></div>

<div class="inputArea">

<input id="input" placeholder="Ask KAALI anything..." autocomplete="off">

<button onclick="send()">Send</button>

<button onclick="startVoice()">ðŸŽ¤</button>

<button onclick="speakLast()">ðŸ”Š</button>

<span id="rec" class="recording" style="display:none">
Listening...
</span>

</div>

</div>

<script>

let history=JSON.parse(localStorage.getItem("kaaliMemory"))||[];

let lastReply="";
let started=false;


/* ENTER KEY â€” FIXED */

document.getElementById("input").addEventListener("keypress",function(e){

if(e.key==="Enter"){
e.preventDefault();
send();
}

});


/* CLEAN LINKS â€” FIXED */

function cleanLink(url){

return url
.replace(/[)\]\.,]+$/,"")
.replace(/\s/g,"");

}


function clickable(text){

return text.replace(/https?:\/\/[^\s]+/g,function(url){

url=cleanLink(url);

return '<a href="'+url+'" target="_parent" style="color:gold;font-weight:bold;">Open Page</a>';

});

}


/* MEMORY SAVE */

function save(){

localStorage.setItem("kaaliMemory",JSON.stringify(history));

}



/* SEND */

async function send(){

let input=document.getElementById("input");

let msg=input.value.trim();

if(!msg) return;

input.value="";

let box=document.getElementById("messages");


if(!started){

let greet="Namaste! I am KAALI, your mystical guide at DEJOIY. How may I assist you today.";

box.innerHTML+="<div class='kaali'>"+greet+"</div>";

history.push({role:"assistant",content:greet});

save();

started=true;

}


box.innerHTML+="<div class='user'>"+msg+"</div>";

history.push({role:"user",content:msg});

save();


box.innerHTML+="<div class='kaali'>KAALI thinking...</div>";

box.scrollTop=box.scrollHeight;



let res=await fetch("/api/chat",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({messages:history})

});


let data=await res.json();


box.removeChild(box.lastChild);



/* REDIRECT */

if(data.url){

window.parent.location.href=cleanLink(data.url);

return;

}


history.push({

role:"assistant",
content:data.reply

});

save();

lastReply=data.reply;



box.innerHTML+=
"<div class='kaali'>"+clickable(data.reply)+"</div>";



if(data.goto){

box.innerHTML+=

"<div class='gotoBtn' onclick=\"window.parent.location.href='"+cleanLink(data.goto)+"'\">Open Page</div>";

}


box.scrollTop=box.scrollHeight;

}



/* VOICE */

function startVoice(){

let rec=document.getElementById("rec");

rec.style.display="inline";

let speech=new(window.SpeechRecognition||window.webkitSpeechRecognition)();

speech.lang="en-IN";

speech.start();

speech.onresult=function(e){

rec.style.display="none";

document.getElementById("input").value=
e.results[0][0].transcript;

send();

};

speech.onerror=function(){

rec.style.display="none";

};

}


/* GODDESS VOICE */

function speakLast(){

if(!lastReply) return;

let clean=lastReply.replace(/[^a-zA-Z0-9 .]/g,"");

let speech=new SpeechSynthesisUtterance(clean);

speech.rate=.9;
speech.pitch=1.3;

speech.lang="en-IN";

speechSynthesis.speak(speech);

}

</script>

</body>
</html>
